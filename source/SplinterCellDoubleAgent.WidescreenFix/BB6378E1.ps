//
// Generated by Microsoft (R) D3DX9 Shader Compiler 9.12.589.0000
//
// Parameters:
//
//   sampler2D BlurredTexture;
//   float4 CinematicFactors;
//   sampler2D DepthTexture;
//   float4 ScreenDimension;
//
//
// Registers:
//
//   Name             Reg   Size
//   ---------------- ----- ----
//   CinematicFactors c20      1
//   ScreenDimension  c21      1
//   BlurredTexture   s1       1
//   DepthTexture     s2       1
//
//
// Default values:
//
//   CinematicFactors
//     c20  = { 0, 0, 0, 0 };
//
//   ScreenDimension
//     c21  = { 0, 0, 0, 0 };
//

ps_3_0

def c0, 3, -3, -9.99999975e-005, 9.99999975e-005
def c1, 0.25, 0.5, 0, 0
def c2, 0.50000000, 1.00000000, 0, 0   // c2.x = depth threshold, c2.y = 1.0

dcl_texcoord v0.xy                      // screen coord
dcl_2d s1                               // BlurredTexture
dcl_2d s2                               // DepthTexture

mov r0, c0

mad r1, c21.zwzw, r0.xxyx, r0.zzwz
add r1.xy, r1, v0
add r4.xy, r1.zwzw, v0

texld r2, r1, s1
texld r1, r1, s2                        // depth0 → r1.x

texld r3, r4, s1
texld r4, r4, s2                        // depth1 → r4.x

add r2.xyz, r2, r3

mad r0, c21.zwzw, r0.xyyy, r0.zwww
add r3.xy, r0, v0
add r6.xy, r0.zwzw, v0

texld r0, r3, s1
texld r3, r3, s2                        // depth2 → r3.x

add r5.xyz, r2, r0

texld r0, r6, s1
texld r2, r6, s2                        // depth3 → r2.x

// Gather depths into r1.xyzw
mov r1.y, r4.x
mov r1.z, r3.x
mov r1.w, r2.x

// Original CoC calculation (with abs fix)
add r1, r1, -c20.y
abs r1, r1                              // FIXED: abs instead of |
add r1, r1, -c20.z
rcp r0.w, c20.z
mul r1, r1, r0.w
mul_sat r1, r1, c1.y                    // coc in [0, 0.5]

// Invert to get blur weights (higher coc → lower weight, like original rsq/rcp chain)
rsq r1.x, r1.x
rsq r1.y, r1.y
rsq r1.z, r1.z
rsq r1.w, r1.w
rcp r1.x, r1.x                          // weight.x = 1 / sqrt(coc)
rcp r1.y, r1.y
rcp r1.z, r1.z
rcp r1.w, r1.w

// NEW: Compute avg_depth of the 4 samples
add r7.x, r1.x, r1.y
add r7.x, r1.z, r7.x
add r7.x, r1.w, r7.x
mul r7.x, r7.x, c1.x                    // r7.x = avg_depth

// NEW: Create far_mask = 1 if avg_depth >= c2.x, else 0
// (cheap: add + mul + max → positive if >= thresh)
add r7.y, r7.x, -c2.x                   // diff = avg - thresh
mul r7.y, r7.y, c2.y                    // scale (optional, but helps if thresh small)
max r7.y, r7.y, c1.z                    // clamp negative → 0
min r7.y, r7.y, c2.y                    // clamp >1 → 1 (far_mask)

// Apply mask: zero weights if close (foreground sharp)
mul r1, r1, r7.y

// Sum weights
add r0.w, r1.y, r1.x
add r0.w, r1.z, r0.w
add r0.w, r1.w, r0.w

// Sum colors (r5 has sum of first 3, r0 is 4th)
add r0.xyz, r5, r0

// Final scaling (original)
mul r0.w, r0.w, c20.w
mul oC0.xyz, r0, c1.x                   // avg blurred RGB
mul oC0.w, r0.w, c1.x                   // avg blur weight (alpha)